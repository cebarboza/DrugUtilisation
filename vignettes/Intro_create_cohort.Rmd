title: "Use DrugUtilisation to create cohort"
author: "Marti Catala, Mike Du, Yuchen Guo, Kim Lopez-Guell, Edward Burn, Xintong Li"
date: '2023-09-25'
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Use DrugUtilisation to create cohort}
%\VignetteEncoding{UTF-8}
%\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---
  
```{r , include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Create mock data first

```{r setup,message= FALSE, warning=FALSE}
library(DrugUtilisation)
library(CodelistGenerator)
library(CDMConnector)
library(dplyr)
cdm <- mockDrugUtilisation(numberIndividual = 100)
```

# Get concept code for cohort generation
To generate a cohort, we will need a concept list, this can be obtained through different ways.

1. Get from json file.
2. Use concept code directly.
3. Get ingredient
4. Get ATC code

To get it from json file, both function readConceptList() and codesFromConceptSet() can be used.
```{r}
#get concept from json file using readConceptList from this package or CodelistGenerator
conceptSet_json_1 <- readConceptList(here::here("inst/Concept"), cdm)
conceptSet_json_2 <- codesFromConceptSet(here::here("inst/Concept"), cdm)

conceptSet_json_1
conceptSet_json_2
```
Or a list can be created manually with the target codes:
  ```{r}
#get concept using code directly
conceptSet_code <- list(asthma = 317009)
conceptSet_code
```
If there is a certain ingredient of interest, code can also be obtained by getDrugIngredientCodes() from CodelistGenerator.
```{r, message=FALSE, warning=FALSE}
#get concept by ingredient
conceptSet_ingredient <- getDrugIngredientCodes(cdm, name = "simvastatin")
conceptSet_ingredient
```
ATC code can also be obtained, using getATCCodes() from CodelistGenerator.
```{r, message=FALSE, warning=FALSE}
```


```{r, message=FALSE, warning=FALSE}
#get concept from ATC codes
conceptSet_ATC <- getATCCodes(cdm, 
                              level = "ATC 1st", 
                              name = "ALIMENTARY TRACT AND METABOLISM")
conceptSet_ATC
```
# Create cohort
Now having the conceptSet, we can proceed to generate cohort. There are two functions in this package to generate cohort:
  
  1. generateConceptCohortSet: to generate a cohort for a certain list of concepts, which does not have to be drug. This function is exported from CDMConnector
2. generateDrugUtilisationCohortSet: to generate a cohort of the drug use

## generateConceptCohortSet()

First, let's use generateConceptCohortSet to get the asthma cohort using the conceptSet_code, it will also give the same output if changed to conceptSet_json_1 or conceptSet_json_2, as they are using the same concept code. 

```{r, message=FALSE, warning=FALSE}
cdm <- generateConceptCohortSet(cdm,
  conceptSet = conceptSet_code,
  name = "asthma_1",
  end = "observation_period_end_date",
  requiredObservation = c(10, 10),
  overwrite = TRUE
)
cdm$asthma_1
```
The count of the cohort can be assessed using cohortCount() from CDMConnector
```{r, message=FALSE, warning=FALSE}
cohortCount(cdm$asthma_1)
```
Cohort attrition can be assessed using cohortAttrition() from CDMConnector
```{r, message=FALSE, warning=FALSE}
cohortAttrition(cdm$asthma_1)
```

The *end* parameter set how the cohort end date is defined. Now it is changed to event end date to demonstrate the difference from previous observation period end date. See that now the cohort_end_date is different:
```{r, message=FALSE, warning=FALSE}
cdm <- generateConceptCohortSet(cdm,
  conceptSet = conceptSet_code,
  name = "asthma_2",
  end = "event_end_date",
  requiredObservation = c(10, 10),
  overwrite = TRUE
)
cdm$asthma_2
```

The *requiredObservation* parameter is a numeric vector of length 2, that defines the number of days of
required observation time prior to index and post index for an event to be included in the cohort. Let's check it now to see how reducing required observation affect the asthma_1 cohort.

```{r, message=FALSE, warning=FALSE}
cdm <- generateConceptCohortSet(cdm,
                                conceptSet = conceptSet_code,
                                name = "asthma_3",
                                end = "observation_period_end_date",
                                requiredObservation = c(1, 1),
                                overwrite = TRUE
)
cdm$asthma_3
cohortCount(cdm$asthma_3)
cohortAttrition(cdm$asthma_3)

```

## generateDrugUtilisationCohortSet()
Now let's try function DrugUtilisation::generateDrugUtilisationCohortSet() to get the drug cohort for ingredient simvastatin. This function has a lot more options you can set. We first use default settings:
```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
  name = "dus_alleras",
  conceptSetList = conceptSet_ingredient,
  # summariseMode = "AllEras",
  # daysPriorObservation = 0,
  # gapEra = 0,
  # priorUseWashout = 0,
  # cohortDateRange = as.Date(c(NA, NA)),
  # imputeDuration = "eliminate",
  # durationRange = c(1, Inf),
  # gapEra = 0
)
cdm$dus_alleras

cohortCount(cdm$dus_alleras)

cohortAttrition(cdm$dus_alleras) %>% select(number_records, reason, excluded_records, excluded_subjects)

```

### durationRange

The parameter *durationRange* specifies the range within which the duration must fall. It should be a numeric vector of length two, with no NAs and the first value should be equal or smaller than the second one. It can ne set as: "eliminate", "median", "mean", "quantile25", "quantile75". The *dus_step2_0_30* cohort and *dus_alleras* cohort is different in **STEP 2**.

```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
  name = "dus_step2_0_30",
  conceptSetList = conceptSet_ingredient,
  imputeDuration = "eliminate",
  durationRange = c(0, 30) # default as c(1, Inf)
)

cohortAttrition(cdm$dus_step2_0_30) %>% select(number_records, reason, excluded_records, excluded_subjects)


```
### gapEra

The parameter *gapEra* defines the number of days between two continuous drug exposures to be considered as a same era. Now let's change it from 0 to a larger number. From the *dus_step3_alleras* cohort attrition, we can see that when joining era at **STEP 3**, it resulted in less records, compared to the *dus_step2_0_30* cohort, as exposures with less than 30 days gaps are joined.

```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
                                        name = "dus_step3_alleras",
                                        conceptSetList = conceptSet_ingredient,
                                        imputeDuration = "eliminate",
                                        durationRange = c(0, 30),
                                        gapEra = 30 # default as 0 
)

cohortAttrition(cdm$dus_step3_alleras) %>% select(number_records, reason, excluded_records, excluded_subjects)

```

### priorUseWashout

The parameter *priorUseWashout* defines prior days without exposure (washout) required. It is set to NULL as default, which leads to no washout required. Here we can see the decrease in number of record in **STEP 4** for cohort *dus_alleras_step4* due to the washout period required, compared to the *dus_step3_alleras* cohort.

```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
                                        name = "dus_alleras_step4",
                                        conceptSetList = conceptSet_ingredient,
                                        imputeDuration = "eliminate",
                                        durationRange = c(0, 30),
                                        gapEra = 30,
                                        priorUseWashout = 30)

cohortAttrition(cdm$dus_alleras_step4) %>% select(number_records, reason, excluded_records, excluded_subjects)

```

### daysPriorObservation

The parameter *daysPriorObservation* set the minimum number of days of prior observation required for the drug eras to be considered. If NULL its is not required to be within observation_period. In this example, we can see the reduction in number of records for *dus_alleras_step5* cohort in **STEP 5**, compared to the *dus_alleras_step4* cohort.

```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
                                        name = "dus_alleras_step5",
                                        conceptSetList = conceptSet_ingredient,
                                        imputeDuration = "eliminate",
                                        durationRange = c(0, Inf),
                                        gapEra = 30,
                                        priorUseWashout = 30,
                                        daysPriorObservation = 30)

cohortAttrition(cdm$dus_alleras_step5) %>% select(number_records, reason, excluded_records, excluded_subjects)

```

### cohortDateRange

The parameter *cohortDateRange* set the range for cohort_start_date and cohort_end_date. In the following example, it can be observed that the reduction in **STEP 6** and **STEP 7** due to the constraint of cohort start and end date.
```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
                                        name = "dus_alleras_step67",
                                        conceptSetList = conceptSet_ingredient,
                                        imputeDuration = "eliminate",
                                        durationRange = c(0, Inf),
                                        gapEra = 30,
                                        priorUseWashout = 30,
                                        daysPriorObservation = 30,
                                        cohortDateRange = as.Date(c("2010-01-01", "2011-01-01"))
)

cohortAttrition(cdm$dus_alleras_step67) %>% select(number_records, reason, excluded_records, excluded_subjects)
```

### summariseMode

Now change the *summariseMode* parameter from AllEras to FirstEra, and see how the *dus_step8_firstera* cohort attrition is affected, compared to the *dus_alleras_step67* cohort. The number_records reduced at **STEP 8** due to the FirstEra summariseMode.

```{r, message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
                                        name = "dus_step8_firstera",
                                        conceptSetList = conceptSet_ingredient,
                                        imputeDuration = "eliminate",
                                        durationRange = c(0, Inf),
                                        gapEra = 30,
                                        priorUseWashout = 30,
                                        daysPriorObservation = 30,
                                        cohortDateRange = as.Date(c("2010-01-01", "2011-01-01")),
                                        summariseMode = "FirstEra")

cohortAttrition(cdm$dus_step8_firstera) %>% select(number_records, reason, excluded_records, excluded_subjects)

```

Similarly, you can set the *summariseMode* to FixedTime and then specify a number for parameter *fixedTime*, and check the cohort attrition.

```{r message=FALSE, warning=FALSE}
cdm <- generateDrugUtilisationCohortSet(cdm,
                                        name = "dus_step8_fixedtime",
                                        conceptSetList = conceptSet_ingredient,
                                        imputeDuration = "eliminate",
                                        durationRange = c(0, Inf),
                                        gapEra = 30,
                                        priorUseWashout = 30,
                                        daysPriorObservation = 30,
                                        cohortDateRange = as.Date(c("2010-01-01", "2011-01-01")),
                                        summariseMode = "FixedTime",
                                        fixedTime = 5)

cohortAttrition(cdm$dus_step8_fixedtime) %>% select(number_records, reason, excluded_records, excluded_subjects)
```


