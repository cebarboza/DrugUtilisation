<<<<<<< HEAD
}
#  daily dose depends on pattern_id: standarisation and function
expect_true(all(compareNA(result %>% dplyr::select(daily_dose) %>% dplyr::pull(),
c(0.005, NA, NA, 29.069, NA, 600, NA, 5.555, NA))))
cdm$drug_exposure %>% dplyr::tally() %>% dplyr::pull("n")
cdm <- mockDrugUtilisation(connectionDetails,
seed = 11,
drug_strength = drug_strength,
numberIndividuals = 50)
cdm[["drug_exposure"]] <- cdm[["drug_exposure"]] %>%
dplyr::group_by(drug_concept_id) %>%
dplyr::filter(dplyr::row_number() == 1)
# should only add patterns 1 to 9, which are drugs 1:7, 10, 11, 25, 30
result <- addDailyDose(cdm$drug_exposure, cdm, 1) %>%
dplyr::collect() %>% dplyr::arrange(drug_concept_id)
result
cdm$drug_exposure
expect_true(nrow(result) == cdm$drug_exposure %>% dplyr::tally() %>% dplyr::pull("n"))
expect_true(all(result %>% dplyr::filter(!is.na(daily_dose)) %>% dplyr::select(drug_concept_id) %>% dplyr::pull() %in% c(1125360, 1516978, 1539462, 2905077)))
compareNA <- function(v1,v2) {
same <- (v1 - v2 < 0.01) | (is.na(v1) & is.na(v2))
same[is.na(same)] <- FALSE
return(same)
}
#  daily dose depends on pattern_id: standarisation and function
expect_true(all(compareNA(result %>% dplyr::select(daily_dose) %>% dplyr::pull(),
c(0.005, NA, NA, 29.069, NA, 600, NA, 5.555, NA))))
cdm$drug_exposure %>% dplyr::tally()
cdm <- mockDrugUtilisation(connectionDetails,
seed = 11,
drug_strength = drug_strength,
numberIndividuals = 50)
cdm[["drug_exposure"]] <- cdm[["drug_exposure"]] %>%
dplyr::group_by(drug_concept_id) %>%
dplyr::filter(dplyr::row_number() == 1) %>%
dplyr::ungroup()
# should only add patterns 1 to 9, which are drugs 1:7, 10, 11, 25, 30
result <- addDailyDose(cdm$drug_exposure, cdm, 1) %>%
dplyr::collect() %>% dplyr::arrange(drug_concept_id)
expect_true(nrow(result) == cdm$drug_exposure %>% dplyr::tally() %>% dplyr::pull("n"))
expect_true(all(result %>% dplyr::filter(!is.na(daily_dose)) %>% dplyr::select(drug_concept_id) %>% dplyr::pull() %in% c(1125360, 1516978, 1539462, 2905077)))
compareNA <- function(v1,v2) {
same <- (v1 - v2 < 0.01) | (is.na(v1) & is.na(v2))
same[is.na(same)] <- FALSE
return(same)
}
#  daily dose depends on pattern_id: standarisation and function
expect_true(all(compareNA(result %>% dplyr::select(daily_dose) %>% dplyr::pull(),
c(0.005, NA, NA, 29.069, NA, 600, NA, 5.555, NA))))
drug_strength <- dplyr::tibble(
drug_concept_id = c(1:37),
ingredient_concept_id = c(rep(1,37)),
amount_value = c(-100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
# pattern 1 also NA because of numerator < 0, pattern 3 NA because of quantity < 0, pattern 2 calculation changes
drug_exposure <- dplyr::tibble(
drug_exposure_id = c(1,2,3,4),
person_id = c(1,1,1,1),
drug_concept_id = c(1,2,15,3),
drug_exposure_start_date = c(as.Date("2018-11-02"), as.Date("2010-04-04"), as.Date("2014-02-18"), as.Date("2014-01-07")),
drug_exposure_end_date = c(as.Date("2018-11-09"), as.Date("2010-05-02"), as.Date("2014-02-25"), as.Date("2014-01-06")),
quantity = c(8,21,8,8)
)
cdm <- mockDrugUtilisation(connectionDetails,
drug_strength = drug_strength,
drug_exposure = drug_exposure)
result <- addDailyDose(cdm$drug_exposure, cdm, 1) %>%
dplyr::collect() %>% dplyr::arrange(drug_concept_id)
expect_true(nrow(result) == cdm$drug_exposure %>% dplyr::tally() %>% dplyr::pull("n"))
expect_true(all(result %>% dplyr::filter(!is.na(daily_dose)) %>% dplyr::select(drug_concept_id) %>% unique() %in% c(2)))
compareNA <- function(v1,v2) {
same <- (v1 - v2 < 0.01) | (is.na(v1) & is.na(v2))
same[is.na(same)] <- FALSE
return(same)
}
# daily dose depends on pattern_id: standarisation and function
expect_true(all(compareNA(result %>% dplyr::select(daily_dose) %>%
dplyr::arrange("drug_concept_id") %>% dplyr::pull(),
c(NA, 0.1448, NA, NA))))
compareNAchar <- function(v1,v2) {
same <- (v1 == v2) | (is.na(v1) & is.na(v2))
same[is.na(same)] <- FALSE
return(same)
}
expect_true(all(compareNAchar(result %>% dplyr::select(unit) %>%
dplyr::arrange("drug_concept_id") %>% dplyr::pull(),
c("international unit", "milligram", "milligram", NA))))
drug_strength <- dplyr::tibble(
drug_concept_id = c(2905077,  1516983,   2905075,  1503327,  1516978,  1503326,   1503328,   1516980,  29050773, 1125360,   15033297,  15030327,
15033427, 15036327,  15394662, 43135274, 11253605, 431352774, 431359274, 112530,   1539465,  29050772,  431352074, 15394062,
43135277, 15033327,  11253603, 15516980, 5034327,  1539462,   15033528,  15394636, 15176980, 1539463,   431395274, 15186980,
15316978),
ingredient_concept_id = c(1,2,rep(1,33),2,3),
amount_value = c(100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
cdm <- mockDrugUtilisation(connectionDetails,
seed = 11,
drug_strength = drug_strength,
numberIndividuals = 50)
cdm[["drug_exposure"]] <- cdm[["drug_exposure"]] %>%
dplyr::group_by(drug_concept_id) %>%
dplyr::filter(dplyr::row_number() == 1) %>%
dplyr::ungroup()
drug_strength <- dplyr::tibble(
drug_concept_id = c(2905077,  1516983,   2905075,  1503327,  1516978,  1503326,   1503328,   1516980,  29050773, 1125360,   15033297,  15030327,
15033427, 15036327,  15394662, 43135274, 11253605, 431352774, 431359274, 112530,   1539465,  29050772,  431352074, 15394062,
43135277, 15033327,  11253603, 15516980, 5034327,  1539462,   15033528,  15394636, 15176980, 1539463,   431395274, 15186980,
15316978),
ingredient_concept_id = c(1,2,rep(1,33),2,3),
amount_value = c(100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
cdm <- mockDrugUtilisation(connectionDetails,
seed = 11,
drug_strength = drug_strength,
numberIndividuals = 50)
cdm[["drug_exposure"]] <- cdm[["drug_exposure"]] %>%
dplyr::group_by(drug_concept_id) %>%
dplyr::filter(dplyr::row_number() == 1) %>%
dplyr::ungroup()
result
cdm$drug_exposure
result <- addDailyDose(cdm$drug_exposure, cdm, 2) %>%
dplyr::collect() %>% dplyr::arrange(drug_concept_id)
result
drug_strength <- dplyr::tibble(
drug_concept_id = c(2905077,  1516983,   2905075,  1503327,  1516978,  1503326,   1503328,   1516980,  29050773, 1125360,   15033297,  15030327,
15033427, 15036327,  15394662, 43135274, 11253605, 431352774, 431359274, 112530,   1539465,  29050772,  431352074, 15394062,
43135277, 15033327,  11253603, 15516980, 5034327,  1539462,   15033528,  15394636, 15176980, 1539463,   431395274, 15186980,
15316978),
ingredient_concept_id = c(2,1,rep(1,33),2,3),
amount_value = c(100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
cdm <- mockDrugUtilisation(connectionDetails,
seed = 11,
drug_strength = drug_strength,
numberIndividuals = 50)
cdm[["drug_exposure"]] <- cdm[["drug_exposure"]] %>%
dplyr::group_by(drug_concept_id) %>%
dplyr::filter(dplyr::row_number() == 1) %>%
dplyr::ungroup()
result <- addDailyDose(cdm$drug_exposure, cdm, 2) %>%
dplyr::collect() %>% dplyr::arrange(drug_concept_id)
result
expect_true(nrow(result) == cdm$drug_exposure %>% dplyr::tally() %>% dplyr::pull("n"))
expect_true(all(result %>% dplyr::filter(!is.na(daily_dose)) %>% dplyr::select(drug_concept_id) %>% dplyr::pull() %in% c(2905077 )))
compareNA <- function(v1,v2) {
same <- (v1 - v2 < 0.01) | (is.na(v1) & is.na(v2))
same[is.na(same)] <- FALSE
return(same)
}
expect_true(all(compareNA(result %>% dplyr::select(daily_dose) %>% dplyr::pull(),
c(NA, NA, NA, NA, NA, NA, NA, 5.555, NA))))
cdm$person
cdm$drug_exposure
cdm$drug_strength
cdm$drug_strength %>% dplyr::select(ingredient_concept_id) %>% dplyr::distinct()
conceptList
x <- readConceptList(
cdm = cdm, path =  system.file(package = "DrugUtilisation", "concepts")
)
x
cdm$drug_exposure
cdm$drug_exposure %>% dplyr::filter(drug_concept_id %in% x)
x
unlist(x)
cdm$drug_exposure %>% dplyr::filter(drug_concept_id %in% unlist(x))
unlist(x) %>% dplyr::pull()
unlist(x)
unname(unlist(x))
cdm$drug_exposure %>% dplyr::filter(drug_concept_id %in% unname(unlist(x)))
concepts <- unname(unlist(x))
cdm$drug_exposure %>% dplyr::filter(drug_concept_id %in% concepts)
cdm$drug_strength
cdm
devtools::load_all()
drug_strength <- dplyr::tibble(
drug_concept_id = c(2905077,  1516983,   2905075,  1503327,  1516978,  1503326,   1503328,   1516980,  29050773, 1125360,   15033297,  15030327,
15033427, 15036327,  15394662, 43135274, 11253605, 431352774, 431359274, 112530,   1539465,  29050772,  431352074, 15394062,
43135277, 15033327,  11253603, 15516980, 5034327,  1539462,   15033528,  15394636, 15176980, 1539463,   431395274, 15186980,
15316978),
ingredient_concept_id = c(rep(1,37)),
amount_value = c(100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
cdm <- mockDrugUtilisation(connectionDetails,
seed = 11,
drug_strength = drug_strength,
numberIndividuals = 50)
dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
devtools::load_all()
dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
test = dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
test[[1]] %>% dplyr::select(person_id) %>% dplyr::distinct()
test[[1]] %>% dplyr::select(person_id) %>% dplyr::pull()
test[[1]] %>% dplyr::filter(person_id == 17)
devtools::load_all()
test = dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
test
dailyDoseCoverage(cdm, sample = 30, ingredient = 2, conceptList = x)
dailyDoseCoverage(cdm, sample = 30, ingredient = 3, conceptList = x)
dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = x)
dailyDoseCoverage(cdm, sample = 50, ingredient = 1, conceptList = x)
devtools::load_all()
dailyDoseCoverage(cdm, sample = 50, ingredient = 1, conceptList = x)
dailyDoseCoverage(cdm, sample = 30, ingredient = 1, conceptList = x)
dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = x)
45*100/2477
x
cdm$drug_exposure
result
test <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = x)
test[[1]]
test[[1]] %>% dplyr::filter(!is.na(daily_dose))
test[[1]] %>% dplyr::select(person_id) %>% dplyr::distinct()
devtools::load_all()
dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = x, seed = 2)
dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = x, seed = 1)
devtools::load_all()
drug_strength <- dplyr::tibble(
drug_concept_id = c(1:37),
ingredient_concept_id = c(rep(1,37)),
amount_value = c(-100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
# pattern 1 also NA because of numerator < 0, pattern 3 NA because of quantity < 0, pattern 2 calculation changes
drug_exposure <- dplyr::tibble(
drug_exposure_id = c(1,2,3,4),
person_id = c(1,1,1,1),
drug_concept_id = c(1,2,15,3),
drug_exposure_start_date = c(as.Date("2018-11-02"), as.Date("2010-04-04"), as.Date("2014-02-18"), as.Date("2014-01-07")),
drug_exposure_end_date = c(as.Date("2018-11-09"), as.Date("2010-05-02"), as.Date("2014-02-25"), as.Date("2014-01-06")),
quantity = c(8,21,8,8)
)
cdm <- mockDrugUtilisation(connectionDetails,
drug_strength = drug_strength,
drug_exposure = drug_exposure)
concepts <- readConceptList(
cdm = cdm, path =  system.file(package = "DrugUtilisation", "concepts")
)
result <- dailyDoseCoverage(cdm, sample = 2, ingredient = 1, conceptList = concepts)
result
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300),
concept_2 = c(3)
)
result <- dailyDoseCoverage(cdm, sample = 2, ingredient = 1, conceptList = concepts)
concepts
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300),
concept_3 = c(3)
)
result <- dailyDoseCoverage(cdm, sample = 2, ingredient = 1, conceptList = concepts)
result
devtools::load_all()
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300),
concept_3 = c(3)
)
result <- dailyDoseCoverage(cdm, sample = 2, ingredient = 1, conceptList = concepts)
result
cdm$person
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
result
dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts, seed = 11)
dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts, seed = 11)
devtools::load_all()
dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts, seed = 11)
sample = 10
ingredient = 1
conceptList = concepts
seed = 11
set.seed(seed)
concepts_interest <- unname(unlist(conceptList))
concepts_interest
cdm$drug_exposure %>%
dplyr::filter(drug_concept_id %in% concepts_interest)
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(3)
)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
result
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(3)
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
result
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(2)
)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
result
devtools::load_all()
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
expect_true(result == 33.333)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
expect_true(result == 0)
x <- readConceptList(
cdm = cdm, path =  system.file(package = "DrugUtilisation", "concepts")
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
expect_true(result == 0)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
expect_true(result == 33.333)
result
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(2)
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
expect_true(result == 33.333)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
expect_true(result == 0)
concepts <- readConceptList(
cdm = cdm, path =  system.file(package = "DrugUtilisation", "concepts")
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
expect_true(result == 0)
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(2)
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
result
expect_true(result == 33.33333)
expect_true(result - 33.33333 < 0.001)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1)
expect_true(result == 0)
result
drug_strength <- dplyr::tibble(
drug_concept_id = c(1:37),
ingredient_concept_id = c(rep(1,37)),
amount_value = c(100,200,300,400,500,600,700,rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,53,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
cdm <- mockDrugUtilisation(connectionDetails,
drug_strength = drug_strength,
numberIndividuals = 50)
expect_error(dailyDoseCoverage())
expect_error(dailyDoseCoverage(cdm = "cdm", ingredient = 2, sample = 10))
expect_error(dailyDoseCoverage(cdm = cdm, ingredient = "alcohol", sample = 1))
expect_error(dailyDoseCoverage(cdm = cdm, ingredient = 2, sample = "exposure"))
expect_error(dailyDoseCoverage(cdm = cdm, ingredient = "alcohol", sample = c(4,5)))
devtools::document()
devtools::check()
devtools::check()
devtools::load_all()
devtools::load_all()
devtools::load_all()
devtools::check()
devtools::load_all()
devtools::check()
drug_strength <- dplyr::tibble(
drug_concept_id = c(1:37),
ingredient_concept_id = c(rep(1,37)),
amount_value = c(-100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
# pattern 1 also NA because of numerator < 0, pattern 3 NA because of quantity < 0, pattern 2 calculation changes
drug_exposure <- dplyr::tibble(
drug_exposure_id = c(1,2,3,4),
person_id = c(1,1,2,3),
drug_concept_id = c(1,2,15,3),
drug_exposure_start_date = c(as.Date("2018-11-02"), as.Date("2010-04-04"), as.Date("2014-02-18"), as.Date("2014-01-07")),
drug_exposure_end_date = c(as.Date("2018-11-09"), as.Date("2010-05-02"), as.Date("2014-02-25"), as.Date("2014-01-06")),
quantity = c(8,21,8,8)
)
cdm <- mockDrugUtilisation(connectionDetails,
drug_strength = drug_strength,
drug_exposure = drug_exposure)
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(2)
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
expect_true(result - 33.33333 < 0.001)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
connectionDetails <- list(
con = DBI::dbConnect(duckdb::duckdb(), ":memory:"),
writeSchema = "main",
writePrefix = NULL
)
drug_strength <- dplyr::tibble(
drug_concept_id = c(1:37),
ingredient_concept_id = c(rep(1,37)),
amount_value = c(-100,200,300,400,500,600,700,rep(NA,30)),
amount = c(rep("numeric",7),rep(NA,30)),
amount_unit_concept_id = c(8718, 9655, 8576, 44819154, 9551, 8587, 9573, rep(NA,30)),
numerator_value = c(rep(NA,7),1,300,5,10,13,20,3,5,2,1,1,4,11,270,130,32,34,40,42,15,100,105,25,44,7,3,8,12,1,31),
numerator = c(rep(NA,7),rep("numeric",30)),
denominator_unit_concept_id = c(rep(NA,7),8576, 8587, 8505,8505,8587,8587,45744809,8519,8587,8576,8576,8587,8576,8587,8576,8587,8587,8505,8587,
8576,8587,45744809,8505,8519,8576,8587,8576,8587,8576,8587),
denominator_value = c(rep(NA,7),241,30,23,410,143,2,43,15,21,1,11,42,151,20,rep(NA,16)),
denominator = c(rep(NA,7),rep("numeric",14),rep(NA,16)),
numerator_unit_concept_id = c(rep(NA,7),8718,8718,9655,8576,44819154,9551,8576,8576,8576,8576,8587,8587,9573,9573,8718,8718,9439,9655,44819154,
9551,9551,8576,8576,8576,8576,8576,8587,8587,9573,9573)
)
# pattern 1 also NA because of numerator < 0, pattern 3 NA because of quantity < 0, pattern 2 calculation changes
drug_exposure <- dplyr::tibble(
drug_exposure_id = c(1,2,3,4),
person_id = c(1,1,2,3),
drug_concept_id = c(1,2,15,3),
drug_exposure_start_date = c(as.Date("2018-11-02"), as.Date("2010-04-04"), as.Date("2014-02-18"), as.Date("2014-01-07")),
drug_exposure_end_date = c(as.Date("2018-11-09"), as.Date("2010-05-02"), as.Date("2014-02-25"), as.Date("2014-01-06")),
quantity = c(8,21,8,8)
)
cdm <- mockDrugUtilisation(connectionDetails,
drug_strength = drug_strength,
drug_exposure = drug_exposure)
concepts <- list(
concept_1 = c(1,30,4),
concept_2 = c(300, 15),
concept_3 = c(2)
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
expect_true(result - 33.33333 < 0.001)
result <- dailyDoseCoverage(cdm, sample = 5, ingredient = 1, conceptList = concepts)
result
expect_true(result == 0)
concepts <- readConceptList(
cdm = cdm, path =  system.file(package = "DrugUtilisation", "concepts")
)
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1, conceptList = concepts)
expect_true(is.na(result))
result <- dailyDoseCoverage(cdm, sample = 10, ingredient = 1)
expect_true(result - 33.33333 < 0.001)
=======
imputeDuration = "eliminate",
imputeDailyDose = "eliminate",
durationRange = c(1, Inf),
dailyDoseRange = c(0, Inf)
))
value_cohort_1 <- c(
61, 0, 0, 61, 3, 5, 1, 1, 0, 0, 2, 1, 1, 10, 41 * 10 + 52 * 20 + 30, 41 + 52 + 1, 61,
0, 3, 0, 0,
41 * 10 + 52 * 20 + 1 * 30, 0, 0
)
xx <- x %>%
dplyr::collect() %>%
dplyr::filter(
subject_id == 1 & cohort_start_date == as.Date("2000-01-01")
)
for (k in 1:length(value_cohort_1)) {
expect_true(xx[[variables[k]]] == value_cohort_1[k])
}
})
targetCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 1, 2),
subject_id = c(1, 1, 2, 3),
cohort_start_date = as.Date(c(
"2020-01-01", "2020-06-01", "2020-01-02", "2020-01-01"
)),
cohort_end_date = as.Date(c(
"2020-04-01", "2020-08-01", "2020-02-02", "2020-03-01"
))
)
indicationCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 2, 3, 1),
subject_id = c(1, 3, 1, 2, 1),
cohort_start_date = as.Date(
c(
"2019-12-30",
"2020-01-01",
"2020-05-25",
"2020-01-01",
"2020-05-25"
)
),
cohort_end_date = as.Date(
c(
"2019-12-30",
"2020-01-01",
"2020-05-25",
"2020-01-01",
"2020-05-25"
)
)
)
attr(indicationCohortName, "cohort_set") <- dplyr::tibble(
cohort_definition_id = c(1, 2),
cohort_name = c("asthma", "covid")
)
condition_occurrence <- dplyr::tibble(
person_id = 1,
condition_start_date = as.Date("2020-05-31"),
condition_end_date = as.Date("2020-05-31")
)
cdm <-
mockDrugUtilisation(
connectionDetails,
cohort1 = targetCohortName,
cohort2 = indicationCohortName,
condition_occurrence = condition_occurrence
)
# check for indication 0
res0 <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = 0,
unknownIndicationTable = NULL
)
res0
devtools::load_all()
# check for indication 0
res0 <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = 0,
unknownIndicationTable = NULL
)
indicationCohortName = "cohort2"
x <- cdm$cohort1
x
indicationGap = 0
unknownIndicationTable = NULL
# check inputs
checkInputs(
x = x, cdm = cdm, indicationCohortName = indicationCohortName,
indicationGap = indicationGap, indicationDate = indicationDate,
unknownIndicationTable = unknownIndicationTable
)
indicationDate = "cohort_start_date"
# check inputs
checkInputs(
x = x, cdm = cdm, indicationCohortName = indicationCohortName,
indicationGap = indicationGap, indicationDate = indicationDate,
unknownIndicationTable = unknownIndicationTable
)
# sort indicationGap
indicationGap <- sort(unique(indicationGap))
# select to interest individuals
ind <- x %>%
dplyr::select(
"subject_id", "cohort_start_date" = dplyr::all_of(indicationDate)
) %>%
dplyr::distinct()
# add indications that are cohorts
ind <- addCohortIndication(ind, cdm, indicationCohortName, indicationGap)
ind
cdm
indicationCohortName
indicationGap
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
)
cohortName <- indicationCohortName
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
)
gap <- 0
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
)
indicationName(gap, "none")
indicationName(gap)
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
dplyr::mutate(!!indicationName(gap, "none") := dplyr::if_else(
rowSums(dplyr::across(dplyr::starts_with(indicationName(gap)))) > 0,
0, 1
))
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
dplyr::mutate(a = dplyr::if_else(
rowSums(dplyr::across(dplyr::starts_with(indicationName(gap)))) > 0,
0, 1
))
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
dplyr::mutate(!!indicationName(gap, "none") := dplyr::if_else(
rowSums(dplyr::select(., dplyr::starts_with(indicationName(gap)))) > 0,
0, 1
))
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
dplyr::mutate(!!indicationName(gap, "none") := rowSums(dplyr::select(., dplyr::starts_with(indicationName(gap)))))
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
dplyr::mutate(!!indicationName(gap, "none") := rowSums(dplyr::select(., dplyr::starts_with(indicationName(gap))))) %>% show_query()
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
dplyr::mutate(!!indicationName(gap, "none") := rowSums(dplyr::select(., dplyr::starts_with(indicationName(gap))))) %>% dplyr::show_query()
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>% #!!indicationName(gap, "none") #indicationName(gap)
dplyr::mutate( x = rowSums(. %>% dplyr::select(dplyr::starts_with("indication")), na.rm = TRUE))
ind
xx <- PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>% collect()
xx <- PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>% dplyr::collect()
xx
xx %>%
select(-"cohort_start_date") %>%
mutate(sum = rowSums(., na.rm=TRUE))
xx %>%
dplyr::select(-"cohort_start_date") %>%
dplyr::mutate(sum = rowSums(., na.rm=TRUE))
xx %>%
dplyr::mutate(x = rowSums(. %>% dplyr::select(dplyr::starts_with("indication")), na.rm = TRUE))
xx %>%
dplyr::mutate(x = rowSums(dplyr::select(., dplyr::starts_with("indication")), na.rm = TRUE))
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>% #!!indicationName(gap, "none") #indicationName(gap)
dplyr::mutate(x = rowSums(dplyr::select(., dplyr::starts_with("indication")), na.rm = TRUE))
xx
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
)
ind
cdm$cohort1
attributes(cdm$cohort1)
columns <- c("a", "bada")
paste0(".data$", columns, collapse = " + ")
parse_quosure
rlang::parse_quosur
parse_expr
rlang::parse_expr()
devtools::load_all()
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
)
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
addNoneIndication(gap)
devtools::load_all()
PatientProfiles::addCohortIntersectFlag(
ind, cdm, cohortName, targetEndDate = NULL, window = c(-gap, 0),
nameStyle = indicationName(gap, "{cohort_name}")
) %>%
addNoneIndication(gap)
x
# sort indicationGap
indicationGap <- sort(unique(indicationGap))
# select to interest individuals
ind <- x %>%
dplyr::select(
"subject_id", "cohort_start_date" = dplyr::all_of(indicationDate)
) %>%
dplyr::distinct()
# add indications that are cohorts
ind <- addCohortIndication(ind, cdm, indicationCohortName, indicationGap)
devtools::load_all()
# select to interest individuals
ind <- x %>%
dplyr::select(
"subject_id", "cohort_start_date" = dplyr::all_of(indicationDate)
) %>%
dplyr::distinct()
# add indications that are cohorts
ind <- addCohortIndication(ind, cdm, indicationCohortName, indicationGap)
ind
# add unknown indications
ind <- addUnknownIndication(ind, cdm, unknownIndicationTable, indicationGap)
ind
# add the indication columns to the original table
result <- x %>%
dplyr::left_join(
ind %>% dplyr::rename(!!indicationDate := "cohort_start_date"),
by = c("subject_id", indicationDate)
) %>%
CDMConnector::computeQuery()
result
result <- PatientProfiles::addAttributes(result, x)
result
targetCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 1, 2),
subject_id = c(1, 1, 2, 3),
cohort_start_date = as.Date(c(
"2020-01-01", "2020-06-01", "2020-01-02", "2020-01-01"
)),
cohort_end_date = as.Date(c(
"2020-04-01", "2020-08-01", "2020-02-02", "2020-03-01"
))
)
indicationCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 2, 3, 1),
subject_id = c(1, 3, 1, 2, 1),
cohort_start_date = as.Date(
c(
"2019-12-30",
"2020-01-01",
"2020-05-25",
"2020-01-01",
"2020-05-25"
)
),
cohort_end_date = as.Date(
c(
"2019-12-30",
"2020-01-01",
"2020-05-25",
"2020-01-01",
"2020-05-25"
)
)
)
attr(indicationCohortName, "cohort_set") <- dplyr::tibble(
cohort_definition_id = c(1, 2),
cohort_name = c("asthma", "covid")
)
condition_occurrence <- dplyr::tibble(
person_id = 1,
condition_start_date = as.Date("2020-05-31"),
condition_end_date = as.Date("2020-05-31")
)
cdm <-
mockDrugUtilisation(
connectionDetails,
cohort1 = targetCohortName,
cohort2 = indicationCohortName,
condition_occurrence = condition_occurrence
)
# check for indication 0
res0 <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = 0,
unknownIndicationTable = NULL
)
res0
expect_true(
setdiff(colnames(res0), colnames(cdm$cohort1)) == "indication_gap_0"
)
expect_true(length(setdiff(colnames(res0), colnames(cdm$cohort1))) == 3)
expect_true(
c("indication_gap_0_asthma", "indication_gap_0_covid",
"indication_gap_0_none") %in%
setdiff(colnames(res0), colnames(cdm$cohort1))
)
expect_true(all(
c("indication_gap_0_asthma", "indication_gap_0_covid",
"indication_gap_0_none") %in%
setdiff(colnames(res0), colnames(cdm$cohort1))
))
res0 %>%
dplyr::filter(.data$subject_id == 3)
res0
res0 <- res0 %>% indicationToStrata()
cohort <- res0
indicationColumns(cohort)
x <- res0
colnames(x)
names <- colnames(x)[substr(colnames(x), 1, 15) == "indication_gap_"]
names
devtools::load_all()
res0 <- res0 %>% indicationToStrata()
cohort <- res0
indicationColumns(cohort)
indicationVariables = indicationColumns(cohort)
keep = FALSE
# check inputs
checkInputs(
cohort = cohort, indicationVariables = indicationVariables, keep = keep
)
errorMessage <- "indicationVariables must point to character columns in cohort"
if (!is.character(indicationVariables) | length(indicationVariables) == 0) {
cli::cli_abort(errorMessage)
}
if (!all(indicationVariables %in% colnames(cohort))) {
cli::cli_abort(errorMessage)
}
cohort <- cohort %>%
dplyr::select(dplyr::all_of(indicationVariables)) %>%
utils::head(1) %>%
dplyr::collect()
PatientProfiles::variableTypes(cohort)
indicationVariables
cli::cli_abort("indicationVariables should start with indication_gap_{gap}")
cli::cli_abort("indicationVariables should start with indication_gap_\{gap|}")
cli::cli_abort("indicationVariables should start with indication_gap_\\{gap|}")
cli::cli_abort("indicationVariables should start with indication_gap_/{gap|}")
cli::cli_abort("indicationVariables should start with indication_gap_/{gap/}")
cli::cli_abort("indicationVariables should start with indication_gap_\{gap\}")
devtools::load_all()
devtools::document()
result <- summariseIndication(
res, cdm, indicationVariables = c(
"indication_gap_inf_asthma", "indication_gap_inf_covid",
"indication_gap_inf_none", "indication_gap_inf_unknown"
)
)
targetCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 1, 2),
subject_id = c(1, 1, 2, 3),
cohort_start_date = as.Date(c(
"2020-01-01", "2020-06-01", "2020-01-02", "2020-01-01"
)),
cohort_end_date = as.Date(c(
"2020-04-01", "2020-08-01", "2020-02-02", "2020-03-01"
))
)
indicationCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 2, 3, 1),
subject_id = c(1, 3, 1, 2, 1),
cohort_start_date = as.Date(c(
"2019-12-30", "2020-01-01", "2020-05-25", "2020-01-01", "2020-05-25"
)),
cohort_end_date = as.Date(c(
"2019-12-30", "2020-01-01", "2020-05-25", "2020-01-01", "2020-05-25"
))
)
condition_occurrence <- dplyr::tibble(
person_id = 1,
condition_start_date = as.Date("2020-05-31"),
condition_end_date = as.Date("2020-05-31")
)
attr(indicationCohortName, "cohort_set") <- dplyr::tibble(
cohort_definition_id = c(1, 2),
cohort_name = c("asthma", "covid")
)
cdm <-mockDrugUtilisation(
connectionDetails, cohort1 = targetCohortName,
cohort2 = indicationCohortName, condition_occurrence = condition_occurrence
)
res <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = c(0, 7, 30, Inf),
unknownIndicationTable = "condition_occurrence"
)
devtools::load_all()
availableConnections <- list(list(
con = DBI::dbConnect(duckdb::duckdb(), ":memory:"),
writeSchema = "main",
writePrefix = NULL
))
k <- 1
connectionDetails <- availableConnections[[k]]
targetCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 1, 2),
subject_id = c(1, 1, 2, 3),
cohort_start_date = as.Date(c(
"2020-01-01", "2020-06-01", "2020-01-02", "2020-01-01"
)),
cohort_end_date = as.Date(c(
"2020-04-01", "2020-08-01", "2020-02-02", "2020-03-01"
))
)
indicationCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 2, 3, 1),
subject_id = c(1, 3, 1, 2, 1),
cohort_start_date = as.Date(c(
"2019-12-30", "2020-01-01", "2020-05-25", "2020-01-01", "2020-05-25"
)),
cohort_end_date = as.Date(c(
"2019-12-30", "2020-01-01", "2020-05-25", "2020-01-01", "2020-05-25"
))
)
condition_occurrence <- dplyr::tibble(
person_id = 1,
condition_start_date = as.Date("2020-05-31"),
condition_end_date = as.Date("2020-05-31")
)
attr(indicationCohortName, "cohort_set") <- dplyr::tibble(
cohort_definition_id = c(1, 2),
cohort_name = c("asthma", "covid")
)
cdm <-mockDrugUtilisation(
connectionDetails, cohort1 = targetCohortName,
cohort2 = indicationCohortName, condition_occurrence = condition_occurrence
)
res <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = c(0, 7, 30, Inf),
unknownIndicationTable = "condition_occurrence"
)
result <- summariseIndication(res, cdm)
targetCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 1, 2),
subject_id = c(1, 1, 2, 3),
cohort_start_date = as.Date(c(
"2020-01-01", "2020-06-01", "2020-01-02", "2020-01-01"
)),
cohort_end_date = as.Date(c(
"2020-04-01", "2020-08-01", "2020-02-02", "2020-03-01"
))
)
indicationCohortName <- dplyr::tibble(
cohort_definition_id = c(1, 1, 2, 3, 1),
subject_id = c(1, 3, 1, 2, 1),
cohort_start_date = as.Date(c(
"2019-12-30", "2020-01-01", "2020-05-25", "2020-01-01", "2020-05-25"
)),
cohort_end_date = as.Date(c(
"2019-12-30", "2020-01-01", "2020-05-25", "2020-01-01", "2020-05-25"
))
)
condition_occurrence <- dplyr::tibble(
person_id = 1,
condition_start_date = as.Date("2020-05-31"),
condition_end_date = as.Date("2020-05-31")
)
attr(indicationCohortName, "cohort_set") <- dplyr::tibble(
cohort_definition_id = c(1, 2),
cohort_name = c("asthma", "covid")
)
cdm <-mockDrugUtilisation(
connectionDetails, cohort1 = targetCohortName,
cohort2 = indicationCohortName, condition_occurrence = condition_occurrence
)
res <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = c(0, 7, 30, Inf),
unknownIndicationTable = "condition_occurrence"
)
result <- summariseIndication(res, cdm)
res
remotes::install_github("darwin-eu-dev/PatientProfiles")
res <- cdm$cohort1 %>%
addIndication(
cdm = cdm, indicationCohortName = "cohort2", indicationGap = c(0, 7, 30, Inf),
unknownIndicationTable = "condition_occurrence"
)
result <- summariseIndication(res, cdm)
devtools::load_all()
result <- summariseIndication(res, cdm)
>>>>>>> a237bc7349589aff3c6c6767b8553c48fcf65043
